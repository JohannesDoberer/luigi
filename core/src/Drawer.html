<svelte:window on:keydown="{handleKeydown}" on:click="{handleClick}" />
<div class="fd-dialog fd-dialog--active" style="z-index:999">
    <div class="fd-dialog__content drawer">
        <div class="fd-dialog__body">
            <div class="iframeDrawerCtn"></div>
        </div>
        {#if showLoadingIndicator}
            <div
            in:fade="{{delay: 250, duration: 250}}"
            out:fade="{{duration: 250}}"
            class="fd-page spinnerContainer"
            aria-hidden="false"
            aria-label="Loading"
            >
                <div
                    class="fd-busy-indicator--m"
                    aria-hidden="false"
                    aria-label="Loading"
                    data-testid="luigi-loading-spinner"
                >
                    <div class="fd-busy-indicator--circle-0"></div>
                    <div class="fd-busy-indicator--circle-1"></div>
                    <div class="fd-busy-indicator--circle-2"></div>
                </div>
            </div>
        {/if}
    </div>
</div>
<script>
    import {
        afterUpdate,
        createEventDispatcher,
        onMount,
        onDestroy
    } from 'svelte';
    import {
        EventListenerHelpers,
        GenericHelpers,
        IframeHelpers,
        RoutingHelpers
    } from './utilities/helpers';
    import { fade } from 'svelte/transition';
    import { Navigation } from './navigation/services/navigation';
    import { KEYCODE_ESC } from './utilities/keycode.js';
    const dispatch = createEventDispatcher();
    export let drawerSettings;
    export let nodepath;
    export let isDataPrepared = false;
    let nodeObject;
    let pathData;
    let nodeParams;
    let iframeCreated = false;
    let showLoadingIndicator = true;
    let clickcounter = 0;

    export function handleKeydown(event) {
        if (event.keyCode === KEYCODE_ESC) {
            dispatch('close');
        }
    }

    export function handleClick(event) {
        clickcounter++;
        if (clickcounter > 1) {
            dispatch('close');
        }
    }


    const onMessage = async e => {
        if ('luigi.show-loading-indicator' === e.data.msg) {
            showLoadingIndicator = true;
        }

        if ('luigi.hide-loading-indicator' === e.data.msg) {
            showLoadingIndicator = false;
        }

        if ('luigi.get-context' === e.data.msg) {
            const loadingIndicatorAutoHideEnabled =
                !nodeObject ||
                !nodeObject.loadingIndicator ||
                nodeObject.loadingIndicator.hideAutomatically !== false;
            if (loadingIndicatorAutoHideEnabled) {
                showLoadingIndicator = false;
            }
        }

        if ('luigi.close-modal' === e.data.msg) {
            dispatch('close');
        }
    };

    onMount(() => {
        EventListenerHelpers.addEventListener('message', onMessage);
    });

    onDestroy(() => {
        EventListenerHelpers.removeEventListener('message', onMessage);
    });

    const prepareNodeData = async path => {
        const pathUrlRaw =
            path && path.length ? GenericHelpers.getPathWithoutHash(path) : '';
        const params = RoutingHelpers.parseParams(pathUrlRaw.split('?')[1]);
        nodeParams = RoutingHelpers.getNodeParams(params);
        const dataFromPath = await Navigation.extractDataFromPath(path);
        nodeObject = dataFromPath.nodeObject;
        pathData = dataFromPath.pathData;

        isDataPrepared = true;
    };

    const getNode = async path => {
        if (iframeCreated) {
            return;
        }
        if (isDataPrepared) {
            const iframe = await createIframeDrawer(nodeObject.viewUrl, {
                context: pathData.context,
                pathParams: pathData.pathParams,
                nodeParams
            });
            dispatch('iframeCreated', {
                drawerIframe: iframe,
                drawerIframeData: { ...pathData, nodeParams }
            });
            iframeCreated = true;
        } else {
            await prepareNodeData(path);
        }
    };
    const createIframeDrawer = async (viewUrl, componentData) => {
        await setDrawerSize();
        if (viewUrl) {
            viewUrl = RoutingHelpers.substituteViewUrl(viewUrl, componentData);
        }

        const iframe = await IframeHelpers.createIframe(
            viewUrl,
            undefined,
            nodeObject,
            'drawer'
        );

        const iframeCtn = document.querySelector('.iframeDrawerCtn');
        iframeCtn.appendChild(iframe);
        return iframe;
    };

    async function setDrawerSize() {
        let styleSettings = '';
        const elem = document.getElementsByClassName('drawer');
        if (drawerSettings.width) {
            styleSettings = `width:${drawerSettings.width};`;
        }
        if (drawerSettings.height) {
            styleSettings += `height:${drawerSettings.height};`;
        }
        if (drawerSettings.position === 'left') {
            styleSettings += `left:0;right:auto;top:0;`;
        } else if (drawerSettings.position === 'right') {
            styleSettings += `left:auto;right:0;top:0;`;
        } else if (drawerSettings.position === 'bottom') {
            styleSettings += `bottom:0;left:auto;right:auto;top:auto`;
        } else if (drawerSettings.position === 'top') {
            styleSettings += `top:0;left:auto;right:auto;`;
        }
        elem[0].setAttribute('style', styleSettings);
    }

    afterUpdate(() => {
        getNode(nodepath);
    });
</script>
<style>
    .drawer {
        top: 44px;
        height: 100vh;
        width: 25vw;
        position: fixed;
        overflow-y: auto;
        left: auto;
        right: 0;
    }

    .iframeDrawerCtn :global(iframe) {
        width: 100%;
        height: 100%;
        border: 0;
        position: absolute;
    }

    .spinnerContainer {
    background: rgba(243, 244, 245, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    bottom: 0;
    right: 0;
    min-width: auto;
    min-height: auto;
    display: flex;
    width: 100%;
    height: 100%;
  }

    .fd-dialog__content {
        max-width: none;
        max-height: none;
        min-width: 0;
    }

    @media (max-width: 599px) {
        .fd-dialog__content:not(.fd-dialog__content--mobile) {
            max-width: none;
            min-width: 50vw;
        }
    }
</style>