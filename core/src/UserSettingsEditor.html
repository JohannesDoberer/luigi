<svelte:window on:click="{closeAllCombos}" on:blur="{closeAllCombos}"></svelte:window>
<script>
    import { onMount, afterUpdate, beforeUpdate, createEventDispatcher } from 'svelte';
    export let userSettingsGroupSchema;
    export let userSettings;
    const dispatch = createEventDispatcher();
    let settingsSchema;
    let userSettingGroup;
    let displayOptions;
    let title;
    beforeUpdate(() => {
        userSettingGroup = userSettingsGroupSchema[0];
        title = userSettingsGroupSchema[1].label;
        settingsSchema = userSettingsGroupSchema[1].settings;
        if (!userSettings.hasOwnProperty(userSettingGroup)) {
            userSettings[userSettingGroup] = {};
        }
    });

    onMount(() => { });

    export function updateSettingsObject() {
        //dispatch('updateSettingsObject', { userSettings })
    }

    function closeAllCombos(self) {
        document.querySelectorAll('.lui-userSettings-content .fd-popover__control').forEach(elem => {
            setExpandedState(elem, false);
        });
    }

    function toggleOptions(event) {
        const self = event.target.closest('.fd-popover__control');
        closeAllCombos(self);
        const currentState = self.getAttribute('aria-expanded') === 'true';
        setExpandedState(self, !currentState);
    }

    function setExpandedState(self, value) {
        const indicatorBtn = self.querySelector('.fd-input-group__button');
        const optionsPopOver = self.parentNode.querySelector('.fd-popover__body');
        self.setAttribute('aria-expanded', value);
        optionsPopOver.setAttribute('aria-hidden', !value);
        indicatorBtn.setAttribute('aria-expanded', value);
    }

    function updateComboBox(key, option) {
        userSettings[userSettingGroup][key] = option;
    }

</script>

<style>
    .lui-form-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
    }

    .lui-value-container {
        grid-column: 2;
    }

    .lui-form-label {
        grid-column: 1;
        text-align: right;
        padding-top: 4px;
    }

    .lui-us-content-header-container {
        width: 100%;
        padding: 1.5rem 2rem;

    }

    .lui-title--h1 {
        font-size: 2.25rem;
        font-size: var(--sapFontHeader1Size, 2.25rem);
    }

    .lui-title {
        line-height: var(--sapContent_LineHeight, 1.4);
        font-family: var(--sapFontFamily, "72", "72full", Arial, Helvetica, sans-serif);
        font-weight: 400;
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        border: 0;
        color: var(--sapTextColor, #32363a);
    }
</style>
<div class="lui-userSettings-content">
    <div class="lui-us-content-header-container">
        <h1 class="lui-title lui-title--h1">{title?title:''}</h1>
    </div>
    <div class="fd-page">
        <div class="fd-page__content">
            <div class="fd-container lui-form-grid">
                {#each Object.entries(settingsSchema) as [key, schemaItem], i}
                    <div class="lui-form-label">
                        <label class="fd-form-label" for="input-07">{schemaItem.label}:</label>
                    </div>
                    <div class="lui-value-container">
                        {#if schemaItem.type==='string'}
                                <input class="fd-input" type="text" placeholder="Field placeholder text" aria-label="Image label"
                                bind:value="{userSettings[userSettingsGroupSchema[0]][key]}" disabled="{schemaItem.isEditable===undefined || schemaItem.isEditable?false:true}" on:input="{() => updateSettingsObject()}">
                        {/if}
                        {#if schemaItem.type==='enum'}
                            <div>
                                <div class="fd-form-item">
                                    <div class="fd-popover">
                                        <div class="fd-popover__control" aria-expanded="false" aria-haspopup="true"
                                            on:click|stopPropagation="{()=>toggleOptions(event)}">
                                            <div class="fd-input-group fd-input-group--control">
                                                <input type="text" class="fd-input fd-input-group__input" placeholder="{userSettings[userSettingsGroupSchema[0]][key]}">
                                                <span class="fd-input-group__addon fd-input-group__addon--button">
                                                    <button
                                                        aria-label="show/hide fruit options"
                                                        aria-expanded="false"
                                                        aria-haspopup="true"
                                                        class="fd-input-group__button fd-button fd-button--transparent">
                                                        <i class="sap-icon--navigation-down-arrow"></i></button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="fd-popover__body fd-popover__body--no-arrow fd-popover__body--dropdown fd-popover__body--dropdown-fill" aria-hidden="true">
                                            <div class="fd-popover__wrapper docs-max-height">
                                                <ul class="fd-list fd-list--dropdown" role="listbox">
                                                    {#each schemaItem.options as option}
                                                        <li role="option" tabindex="0" class="fd-list__item" on:click="{() => updateComboBox(key,option)}">
                                                            <span class="fd-list__title">
                                                                <span class="fd-list__bold">{option}</span>
                                                            </span>
                                                        </li>
                                                    {/each}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {/if}
                    </div>
                {/each}
            </div>
        </div>
    </div>
</div>