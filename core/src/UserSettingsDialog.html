<script>
    import {
        createEventDispatcher,
        onMount,
        onDestroy,
        beforeUpdate
    } from 'svelte';
    import UserSettingsEditor from './UserSettingsEditor.html';
    import { CSS_BREAKPOINTS } from './utilities/constants';
    import { LuigiConfig } from './core-api';
    const dispatch = createEventDispatcher();
    export let schemaObj;
    let userSettingsData = [];
    let userSettingsCategory = [];
    let userSettings = {}
    let userSettingsSchema = {};
    let displayEditor = false;
    let previousUserSettings = {};

    onMount(() => {
        prepareLeftNavData(schemaObj);
        openEditor([userSettingsCategory[0], userSettingsData[0][userSettingsCategory[0]]]);
        LuigiConfig.readUserSettings().then(userSettingsFromStorage => {
            previousUserSettings = JSON.parse(JSON.stringify(userSettingsFromStorage));
            if (userSettingsFromStorage === null) {
                return;
            }
            userSettings = userSettingsFromStorage;
        });
    });

    function prepareLeftNavData(schemaObj) {
        if (schemaObj) {
            for (const item in schemaObj) {
                userSettingsCategory.push(item);
                let innerObj = {};
                innerObj[item] = schemaObj[item];
                userSettingsData.push(innerObj);
            }
        }
    }

    beforeUpdate(() => {
        prepareLeftNavData(schemaObj);
    });

    function openEditor(category) {
        userSettingsSchema = category;
        displayEditor = true;
    }

    const updateSettingsObject = (event) => {
        userSettings = event.detail.userSettings;
    }

    function storeUserSettings() {
        LuigiConfig.storeUserSettings(userSettings, previousUserSettings).then(() => {
            dispatch('close');
            console.info('User settings stored');
        });
    }

    function closeNavOnCategoryClickMobile() {
        toggleNavMobile();
    }

    function toggleNavMobile() {
        document.querySelector('.lui-usersettings-dialog').classList.toggle('usersettings-leftNavVisible');
    }

</script>

<style>
    .dialog-size {
        width: 60vw;
        height: 60vh;
    }

    .user-settings__body {
        position: relative;
        padding-top: 0;
        padding-bottom: 0;
    }

    .user-settings__leftnav {
        position: absolute;
        top: 0;
        left: 0;
        width: 200px;
        height: 100%;
        z-index: 1;
    }

    .fd-side-nav {
        height: 100%;
        width: 100%;
    }

    .user-settings__content {
        position: absolute;
        left: 201px;
        top: 0;
        height: 100%;
        right: 0;
        overflow-wrap: break-word;
        padding: 20px;
    }


    .userSettings-lui-burger {
        margin-right: 16px;
        cursor: pointer;
        display: none;
    }

    @media (max-width: 600px) {
        .userSettings-lui-burger {
            display: block;
            margin-left: 0px;
        }

        :global(.usersettings-leftNavVisible) .user-settings__leftnav {
            width: 200px;
        }

        .user-settings__content {
            left: 0;
        }

        .user-settings__leftnav {
            width: 0;
            transition: 0.5s;
        }

        .fd-nested-list__title {
            padding-right: 0;
        }
    }
</style>

<div class="fd-dialog fd-dialog--active lui-usersettings-dialog">
    <div class="fd-dialog__content dialog-size">
        <div class="fd-dialog__header fd-bar fd-bar--header">
            <div class="fd-bar__left">
                <div class="fd-bar__element">
                    <button class="fd-shellbar__button fd-button sap-icon--menu2 userSettings-lui-burger"
                        on:click="{toggleNavMobile}" tabindex="0"></button>
                </div>
                <div class="fd-bar__element">
                    <h3 class="fd-dialog__title">UserSettings</h3>
                </div>
            </div>
            <div class="fd-bar__right">
                <div class="fd-bar__element">
                    <button
                        class="fd-button fd-button--transparent fd-button--compact fd-dialog__close sap-icon--decline"
                        on:click="{() => dispatch('close')}" aria-label="close"></button>
                </div>
            </div>
        </div>
        <div class="fd-dialog__body user-settings__body">
            <div class="user-settings__leftnav">
                <div class="fd-side-nav">
                    <div class="fd-side-nav__main-navigation">
                        <div class="lui-fd-side-nav-wrapper">
                            <ul class="fd-nested-list">
                                {#each Object.entries(userSettingsData) as [key,item], index}
                                    {#each Object.entries(item) as property}
                                        <li class="fd-nested-list__item">
                                            <a class="fd-nested-list__link" on:click="{() => openEditor(property)}">
                                                <span class="fd-nested-list__title">
                                                    {property[1].label}
                                                </span>
                                            </a>
                                        </li>
                                    {/each}
                                {/each}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="user-settings__content">
                {#if displayEditor}
                    <UserSettingsEditor userSettings={userSettings} userSettingsGroupSchema={userSettingsSchema} on:updateSettingsObject="{updateSettingsObject}"></UserSettingsEditor>
                {/if}
            </div>
        </div>
        <footer class="fd-dialog__footer fd-bar fd-bar--footer">
            <div class="fd-bar__right">
                <div class="fd-bar__element">
                    <button on:click="{() => storeUserSettings()}"
                        class="fd-dialog__decisive-button fd-button fd-button--emphasized fd-button--compact confirm-button">Save</button>
                </div>
                <div class="fd-bar__element">
                    <button on:click="{() => dispatch('close')}"
                        class="fd-dialog__decisive-button fd-button fd-button--transparent fd-button--compact">Dismiss</button>
                </div>
            </div>
        </footer>
    </div>
</div>